<!DOCTYPE html>
<html>
    
  <head>
    <meta charset="utf-8">
    <title>DICE | LVB - Las Vegas In Blockchain</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/lvb.css" rel="stylesheet">
    <link href="css/fontawesome-all.css" rel="stylesheet">
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src=nebPay.js></script>
    <script src=nebulas.js></script>
  </head>
    
  <body>
      <div class="container">
        <nav class="nav navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span> 
                </button>
                <a class="navbar-brand" href="index.html"><i class="fas fa-dollar-sign font-size-6vmin"></i>&nbsp;<span class="font-size-6vmin"><strong>LVB</strong></span></a>
            </div>
            <div class="collapse navbar-collapse navbar-right" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="index.html">主頁</a></li>
                    <li><a href="about.html">關於</a></li>
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#">遊戲<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="dice.html"><i class="fas fa-dice" style="color: dimgray"></i>&nbsp;&nbsp;十八仔</a></li>
                            <li><a href="#">&nbsp;<i class="fas fa-chess-knight" style="color: dimgray"></i>&nbsp;&nbsp;開發中...</a></li>
                        </ul>
                    </li>
                    <li><a href="GetFreeNas.html">領取免費NAS</a></li>
                    <li><a href="https://explorer.nebulas.io/#/address/n1gBggk4BVduVVybypRf9hWg8k1z2gXVVFp">合約地址</a></li>
                </ul>
            </div>
        </div>
        </nav> 
        <div class="row getFreeNas-article text-center Aligner-a">
            <div class="col-md-6 col-xs-12">
                <br><br>
                <i class="fas fa-hand-holding-usd font-size-45vmin grey"></i>
                <br><br><br>
            </div>
            <div class="col-md-6 col-xs-12">
                <div>
                    <span class="font-size-6vmin grey medium">公益基金:</span>
                    <span id=get_donatePoolAmount class="font-size-6vmin grey medium"></span>
                    <span class="font-size-6vmin grey medium">NAS</span>
                </div>
                <br><br>
                <div>
                    <button type="button" class="btn btn-default btn-lg" onclick="javascript: onClickClaim()">
                        <span class="font-size-7vmin grey medium">CLAIM</span>
                    </button>
                    <p class="font-size-2vmin ligth-grey regular">(每10分鐘可領取0.0002NAS)</p>
                </div>
                <br>
                <div>
                    <button type="button" class="btn btn-default btn-lg" onclick="javascript: onClickDonate()">
                        <span class="font-size-3vmin grey medium"><i class="fas fa-donate"></i>&nbsp;贊助公益基金</span>
                    </button>
                </div>
                <br>
                <div>
                    <button type="button" class="btn btn-default btn-lg" data-toggle="modal" data-target="#myModal">
                        <span class="font-size-3vmin grey medium">申請Gas</span>
                    </button>
                </div>
            </div>
        </div>
          
        <!-- 申請Gas Modal -->
          
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <p class="font-size-4vmin black medium">申請Gas</p>
                    </div>
                    <div class="modal-body">
                        <p class="font-size-3vmin">
                            <P class="black medium">歡迎新手用戶加入
                                <a href="https://line.me/ti/p/UExvoy8PdM" class="black"><i class="fab fa-line"></i>line</a>
                                或
                                <a href="mailto:daniel850227@gmail.com" class="black"><i class="fas fa-envelope-square"></i>email</a>
                                申請Gas
                            </P>
                            <P class="black medium">Gas可用在"CLAIM"交易的礦工費。</P>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
      </div>
          
      <!-- Status Modal -->
          
      <div class="modal fade" tabindex="-1" id="statusModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <p class="font-size-3vmin black medium" id="message"></p><i class="fas fa-sync fa-spin font-size-3vmin black"></i>
                </div>
                <div class="modal-footer" id="close">
                    <button type="button" class="btn btn-default grey medium" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
       </div>
          
    </div>
    <footer class="footer text-center">
        <div class="container">
            <br>
            <p class="font-size-2vmin">智能合約中無開發者提幣功能亦不收取平台手續費, 純公益, 請安心使用</p>
            <p class="font-size-2vmin">
                聯絡我們/問題反饋&nbsp;
                <a href="https://t.me/LasVegasInBlockchain" style="color: floralwhite;"><i class="fab fa-telegram" class="contact"></i>telegram</a>&nbsp;
                <a href="https://line.me/ti/p/UExvoy8PdM" style="color: floralwhite;"><i class="fab fa-line"></i>line</a>&nbsp;
                <a href="mailto:daniel850227@gmail.com" style="color: floralwhite;"><i class="fas fa-envelope-square"></i>email</a>
            </p>
            <p class="font-size-2vmin">Powered by NEBULAS</p>
            <div class="font-size-2vmin">Copyright © 2018 LVB</div>
            <br>
        </div>
    </footer>
      
    <script>
        
        "use strict";
        
        var NebPay = require("nebpay");
        var nebPay = new NebPay();
        var serialNumber
        var intervalQuery
        
        //TEST : NebPay.config.testnetUrl; MAIN : NebPay.config.mainnetUrl;
        var callbackUrl = NebPay.config.mainnetUrl; 
        //TEST : n1hbwgvrDJsKQ28ik1pdkwfQWQX8UkdNyXk; MAIN : n1gBggk4BVduVVybypRf9hWg8k1z2gXVVFp;
        var contract_address = "n1gBggk4BVduVVybypRf9hWg8k1z2gXVVFp"; 
        
        
        var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
        
        //主網測試網記得改!!
        neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
        
        //to check if the extension is installed
        //if the extension is installed, var "webExtensionWallet" will be injected in to web page
        if (typeof (webExtensionWallet) === "undefined") {
            alert("請先安裝星雲插件");
        }
        
        $(function() {
            onClickGetDonatePoolAmount();
        })
        
        function onClickGetDonatePoolAmount() {

            var from = Account.NewAccount().getAddressString();
            var value = "0";
            var nonce = "0"
            var gas_price = "1000000"
            var gas_limit = "2000000"
            var callFunction = "getDonatePoolAmount";
            var arg = ""
            var callArgs = JSON.stringify([arg]); 
            var contract = {
                "function": callFunction,
                "args": callArgs
            }
            neb.api.call(from,contract_address,value,nonce,gas_price,gas_limit,contract).then(function (resp) {
                onGetDonatePoolAmount(resp)
            }).catch(function (err) {
                console.log("error:" + err.message)
            })
        }
        
        function onGetDonatePoolAmount(resp) {
            var response = JSON.parse(resp.result);
            var number = response.toFixed(5)
            if(number) {
                $("#get_donatePoolAmount").text(number);
            }
        }
        
        function onClickClaim() {
            showStatus("請確保距離上次領取已超過十分鐘, 否則交易將失敗");
            $("#close").hide();
            serialNumber = nebPay.call(contract_address, "0", "claim", "", {
                callback: callbackUrl,
                //listener: onClaim
            })
            intervalQuery = setInterval(function() {
                funcIntervalQuery_a();
            }, 3000);
        }
        
        function funcIntervalQuery_a() {
            var options = {
                callback: callbackUrl
            }
            nebPay.queryPayInfo(serialNumber,options)   //search transaction result from server (result upload to server by app)
                .then(function (resp) {
                    console.log("tx result: " + resp) //resp is a JSON string
                    var respObject = JSON.parse(resp)
                    if(respObject.code === 0 && respObject.data.status === 2){
                        showStatus("交易上鏈中...");
                        $("#close").hide();
                    }
                    else if(respObject.code === 0 && respObject.data.status === 1) {
                        clearInterval(intervalQuery);
                        showStatus("領取完成!");
                        $("#close").show();
                    }
                    else if(respObject.code === 0 && respObject.data.status === 0) {
                        clearInterval(intervalQuery);
                        showStatus("上鏈失敗, 請重試");
                        $("#close").show();
                    }
                })
                .catch(function (err) {
                    console.log(err);
                });
        }
        
        function onClickDonate() {
            showStatus("請在NAS錢包填寫要發送的金額, 生成交易並確認");
            $("#close").hide();
            var to = contract_address;
            var value = "0.01";
            var callFunction = "donate";
            var callArgs = "";
            var options = {
                callback: callbackUrl,
                //listener: onBid
            }
            serialNumber = nebPay.call(to, value, callFunction, callArgs, options);
            
            intervalQuery = setInterval(function() {
                funcIntervalQuery();
            }, 3000);
        };
        
        function funcIntervalQuery() {
            var options = {
                callback: callbackUrl
            }
            nebPay.queryPayInfo(serialNumber,options)   //search transaction result from server (result upload to server by app)
                .then(function (resp) {
                    console.log("tx result: " + resp) //resp is a JSON string
                    var respObject = JSON.parse(resp)
                    if(respObject.code === 0 && respObject.data.status === 2){
                        showStatus("交易上鏈中...");
                        $("#close").hide();
                    }
                    else if(respObject.code === 0 && respObject.data.status === 1) {
                        clearInterval(intervalQuery);
                        showStatus("完成捐款, 感謝您的善心");
                        $("#close").show();
                    }
                    else if(respObject.code === 0 && respObject.data.status === 0) {
                        clearInterval(intervalQuery);
                        showStatus("上鏈失敗, 請重試");
                        $("#close").show();
                    }
                })
                .catch(function (err) {
                    console.log(err);
                });
        }
        
        function showStatus(message) {
            $('#statusModal').modal({backdrop: 'static', keyboard: false});
            $("#message").text(message);
            $("#statusModal").modal('show');
        }
        
        function closeStatus() {
            $("#statusModal").modal('hide');
        }
        
    </script>
  </body>
    
</html>
